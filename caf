#!/usr/bin/env python3
"""caf -- Calculation framework.

Usage:
    caf build [new]
    caf work [<target>...]
    caf push <remote> [<target>...]
    caf fetch [<target>...]

Commands:

Options:
    -n      New build.
"""
from docopt import docopt
from pathlib import Path
import os

out = 'build'


def load_cscript():
    import imp
    cscript = imp.new_module('cscript')
    try:
        exec(compile(open('cscript').read(), 'cscript', 'exec'), cscript.__dict__)
    except:
        import traceback
        import sys
        print('There was an error while reading cscript.')
        traceback.print_exc()
        sys.exit(1)
    return cscript


if __name__ == '__main__':
    args = docopt(__doc__)
    if args['build']:
        from datetime import datetime
        from caflib.Core import Context, mkdir
        cscript = load_cscript()
        if args['new']:
            timestamp = format(datetime.today(), '%Y-%m-%d_%H:%M:%S')
            mkdir(Path(out)/timestamp)
            os.system('ln -fns {} {}/latest'.format(timestamp, out))
        else:
            timestamp = os.readlink('{}/latest'.format(out))
        ctx = Context(Path().resolve(), timestamp)
        cscript.build(ctx)
        ctx.build()
        ctx.make_targets(Path().resolve()/out/timestamp)
    elif args['work']:
        from caflib.Worker import Worker
        worker = Worker(Path(out)/'latest')
        worker.work(args['<target>'])
