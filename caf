#!/usr/bin/env python3
import sys
from pathlib import Path
import signal
import os


def unpack(caf, path: ('--path', Path), force: '--force'):
    """
    Unpack caflib from the caf executable.

    Usage:
        caf unpack [-f] [--path PATH]

    Options:
        --path PATH        Path to which symlink caflib [default: .caf]
        -f, --force        Do not use cache.
    """
    from base64 import b64decode
    import tarfile
    import io
    from tempfile import gettempdir
    import shutil
    tmpdir = Path(gettempdir())/'caf'
    if not tmpdir.is_dir():
        tmpdir.mkdir()
    with open(__file__) as f:
        for line in f:
            if line == '# ==>\n':
                break
        else:
            raise RuntimeError('No packed caflib')
        version = next(f)[:-1].split(maxsplit=2)[-1]
        caflibpath = tmpdir/version
        if caflibpath.is_dir() and force:
            shutil.rmtree(str(caflibpath))
        if not caflibpath.is_dir():
            archive = b64decode(next(f)[:-1].split(maxsplit=2)[-1])
            with io.BytesIO(archive) as ftar:
                tar = tarfile.open(mode='r|gz', fileobj=ftar)
                tar.extractall(str(caflibpath))
    if path:
        link = path/'caflib'
        target = caflibpath/'caflib'
        linktarget = str(target)
        if link.is_symlink():
            if os.readlink(str(link)) == linktarget:
                return
            else:
                link.unlink()
        if not link.parent.is_dir():
            link.parent.mkdir()
        link.symlink_to(linktarget)
    return str(caflibpath)


if __name__ == '__main__':
    if Path('caflib').is_dir():
        from caflib.Caf import Caf
    else:
        caflibpath = unpack(None, path=None, force=False)
        sys.path.insert(0, caflibpath)
        try:
            from caflib.Caf import Caf
        except ImportError:
            unpack(None, path=None, force=True)
            from caflib.Caf import Caf
    Caf.command()(unpack)
    caf = Caf()
    signal.signal(signal.SIGINT, caf.finalize)
    caf(sys.argv)
