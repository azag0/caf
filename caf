#!/usr/bin/env python3
"""caf -- Calculation framework.

Usage:
    caf build [new]
    caf work

Commands:

Options:
"""
from docopt import docopt


def load_cscript():
    import imp
    cscript = imp.new_module('cscript')
    try:
        exec(compile(open('cscript').read(), 'cscript', 'exec'), cscript.__dict__)
    except:
        import traceback
        import sys
        print('There was an error while reading cscript.')
        traceback.print_exc()
        sys.exit(1)
    return cscript


if __name__ == '__main__':
    args = docopt(__doc__)
    if args['build']:
        from datetime import datetime
        import os
        from caflib.Core import Context, mkdir
        cscript = load_cscript()
        ctx = Context()
        cscript.build(ctx)
        if args['new']:
            blddir = format(datetime.today(), '%Y-%m-%d_%H:%M:%S')
            mkdir('build/{}'.format(blddir))
            os.system('ln -fns {} build/latest'.format(blddir))
        ctx.build()
    elif args['work']:
        from caflib.Worker import Worker
        worker = Worker('build/latest')
        worker.work()
